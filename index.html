<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º ‚Äî Firestore</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    table { border-collapse: collapse; margin-bottom: 12px; width: 100%; max-width: 1200px; }
    table, th, td { border: 1px solid #008000; }
    th, td { padding: 6px; }
    input { width: 140px; }
    .actions { margin-bottom: 12px; }
    .actions button { margin-right: 6px; padding: 6px 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</h2>

  <table id="projectsTable">
    <tr>
      <th>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</th>
      <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞</th>
      <th>–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞</th>
      <th>–°—É–º–º–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</th>
      <th>–î–∞—Ç–∞ –∞–≤–∞–Ω—Å–∞</th>
      <th>% –∞–≤–∞–Ω—Å–∞</th>
      <th>–ü–æ–Ω–∏–∂–µ–Ω–∏–µ (%)</th>
    </tr>
    <tr>
      <td><input type="text" placeholder="–ü—Ä–æ–µ–∫—Ç 1" /></td>
      <td><input type="date" /></td>
      <td><input type="date" /></td>
      <td><input type="number" placeholder="‚ÇΩ" step="0.01" /></td>
      <td><input type="date" /></td>
      <td><input type="number" placeholder="%" step="0.01" /></td>
      <td><input type="number" placeholder="%" step="0.01" /></td>
    </tr>
  </table>

  <div class="actions">
    <button id="btnAdd">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
    <button id="btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="btnGoChart">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // üîπ –í–°–¢–ê–í–¨ –°–í–û–ô –ö–û–ù–§–ò–ì –ò–ó FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBhVal8xu6ORv8bhQZ3zti__wX4x6MzFjE",
        authDomain: "ingvar-projects-gantt.firebaseapp.com",
        projectId: "ingvar-projects-gantt",
        storageBucket: "ingvar-projects-gantt.firebasestorage.app",
        messagingSenderId: "20236808968",
        appId: "1:20236808968:web:0895f9a51283eb5369f2bd",
        measurementId: "G-LX5GK03QB7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function signIn() {
      await signInAnonymously(auth).catch(() => {});
    }

    function attachListeners(row) {
      row.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', () => {});
      });
    }

    function readTable() {
      return Array.from(document.querySelectorAll('#projectsTable tr')).slice(1)
        .map(row => Array.from(row.querySelectorAll('input')).map(inp => inp.value || ''));
    }

    function writeTable(data) {
      const table = document.getElementById('projectsTable');
      while (table.rows.length > 1) table.deleteRow(1);
      if (!data || data.length === 0) { addRow(); return; }
      data.forEach(rowData => {
        const row = table.insertRow();
        for (let i = 0; i < 7; i++) {
          const cell = row.insertCell();
          const input = document.createElement('input');
          if (i === 0) input.type = 'text';
          if ([1, 2, 4].includes(i)) input.type = 'date';
          if ([3, 5, 6].includes(i)) { input.type = 'number'; input.step = '0.01'; }
          input.value = rowData[i] || '';
          cell.appendChild(input);
        }
        attachListeners(row);
      });
    }

    function addRow() {
      const row = document.getElementById('projectsTable').insertRow();
      for (let i = 0; i < 7; i++) {
        const cell = row.insertCell();
        const input = document.createElement('input');
        if (i === 0) input.type = 'text';
        if ([1, 2, 4].includes(i)) input.type = 'date';
        if ([3, 5, 6].includes(i)) { input.type = 'number'; input.step = '0.01'; }
        cell.appendChild(input);
      }
      attachListeners(row);
    }

    async function saveToFirestore() {
      const data = readTable();
      await setDoc(doc(db, "projects", "main"), { table: data });
      alert("–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firestore");
    }

    async function loadFromFirestore() {
      const snap = await getDoc(doc(db, "projects", "main"));
      if (snap.exists()) {
        writeTable(snap.data().table);
      } else {
        addRow();
      }
    }

    document.getElementById('btnAdd').addEventListener('click', addRow);
    document.getElementById('btnSave').addEventListener('click', saveToFirestore);
    document.getElementById('btnGoChart').addEventListener('click', async () => {
      await saveToFirestore();
      window.location.href = 'chart.html';
    });

    await signIn();
    await loadFromFirestore();
  </script>
</body>
</html>
